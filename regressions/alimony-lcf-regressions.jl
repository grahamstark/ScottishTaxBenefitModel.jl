
#=
lcf     | 2018 | rawper | DVRegP             |  859 | numeric | scale             | DV for RegAmP                                                                                                     
                                                                              |         1
 lcf     | 2018 | rawper | DVChMainP          |  860 | numeric | scale             | DV for ChMainP                                                                                                                                                                                  |         1
 lcf     | 2018 | rawper | DVAlimP            |  861 | numeric | scale             | DV for AlimAmP                                                                                                                                                                                  |         1
 lcf     | 2018 | rawper | DVMemP             |  862 | numeric | scale             | DV for MeMaMp                                                                                                     


DVILO3a
lcf     | 2020 | rawper | DVILO3a       | 1     | In Employment         | In_Employment
 lcf     | 2020 | rawper | DVILO3a       | 2     | ILO Unemployed        | ILO_Unemployed
 lcf     | 2020 | rawper | DVILO3a       | 3     | Economically Inactive | Economically_Inactive

DVMrDF12 
DVAge4 / 5/6
SSPart
HasChd
DVusGr
DVPROF
Sex 
lcf     | 2017 | rawper | DVUC               |  647 | numeric | SCALE              | DV Universal Credit                                                                                                                                                                             |         1
lcf     | 2016 | rawper | DVWTC              |  896 | numeric | SCALE              | DV for Working Tax Credit                                                                                                                                                                       |         1
 lcf     | 2016 | rawper | DVCTC              |  897 | numeric | SCALE             | DV for Child Tax Credit                                                                                                                                                                         |         1
 lcf     | 2016 | rawper | DVIS               |  898 | numeric | SCALE             | DV for Income Support                                                                                                                                                                           |         1
 lcf     | 2016 | rawper | DVJSA              |  899 | numeric | SCALE             | DV for Job Seekers Allowance                                                                                                                                                                    |         1
 lcf     | 2016 | rawper | DVJSACON           |  900 | numeric | SCALE             | DV for JSA - contributions)                                                                                                                                                                     |         1
 lcf     | 2016 | rawper | DVJSAIB            |  901 | numeric | SCALE             | DV for JSA - income based)                                                                                                                                                                      |         1
 lcf     | 2016 | rawper | DVJSAComb          |  902 | numeric | SCALE             | DV for JSA - Combined                                                                                                                                                                           |         1
 lcf     | 2016 | rawper | DVESA              |  903 | numeric | SCALE             | DV for Empl Support Allowance                                                                                                                                                                   |         1
 lcf     | 2016 | rawper | DVCA               |  904 | numeric | SCALE             | DV for Carer s Allowance                                                                                                                                                                        |         1
 lcf     | 2016 | rawper | DVPIPCar           |  905 | numeric | SCALE             | DV for Personal Independ Payment                                                                                                                                                                |         1
 lcf     | 2016 | rawper | DVPIPMob           |  906 | numeric | SCALE             | DV for Personal Independ Payment                                                                                                                                                                |         1
 lcf     | 2016 | rawper | DVDLACar           |  907 | numeric | SCALE             | DV for Disability Living Allowance                                                                                                                                                              |         1
 lcf     | 2016 | rawper | DVDLAMob           |  908 | numeric | SCALE             | DV for Disability Living Allowance                                                                                                                                                              |         1
 lcf     | 2016 | rawper | DVAA               |  909 | numeric | SCALE             | DV for Attendance All                                                                                                                                                                           |         1
 lcf     | 2016 | rawper | DVSDA              |  910 | numeric | SCALE             | DV for Severe Dis All                                                                                                                                                                           |         1
 lcf     | 2016 | rawper | DVIB               |  911 | numeric | SCALE             | DV for Incapacity Benefit                                                                                                                                                                       |         1
 lcf     | 2016 | rawper | DVIIDB             |  912 | numeric | SCALE             | DV for Industrial Injuries Disabl Ben                                                                                                                                                           |         1
 lcf     | 2016 | rawper | DVPC               |  913 | numeric | SCALE             | DV FOR Pension Credit)                                                                                                                                                                          |         1
 lcf     | 2016 | rawper | DVSRP              |  914 | numeric | SCALE             | DV for State Retirement Pension                                                                                                                                                                 |         1
 lcf     | 2016 | rawper | DVWid              |  915 | numeric | SCALE             | DV for Wid Pen, Bereav All, Wid Parent A                                                                                                                                                        |         1
 lcf     | 2016 | rawper | DVAFCS             |  916 | numeric | SCALE             | DV Armd Forces Comp Sch                                                                                                                                                                         |         1
 lcf     | 2016 | rawper | DVWWP              |  917 | numeric | SCALE             | DV for War Widows Pension                                                                                                                                                                       |         1
 lcf     | 2016 | rawper | DVCB               |  918 | numeric | SCALE             | DV for Child Benefit                                                                                                                                                                            |         1
 lcf     | 2016 | rawper | DVCBTAX            |  919 | numeric | SCALE             | DV for Child benefit tax                                                                                                                                                                        |         1
 lcf     | 2016 | rawper | DVSFFEx            |  920 | numeric | SCALE             | DV for Social Fund Fun Exp Grant                                                                                                                                                                |         1
 lcf     | 2016 | rawper | DVSFMat            |  921 | numeric | SCALE             | DV for Social Fund Maternity Grant                                                                                                                                                              |         1
 lcf     | 2016 | rawper | DVExPay            |  922 | numeric | SCALE             | DV for ExtPaym of Housing Benefit                                                                                                                                                               |         1
 lcf     | 2016 | rawper | DVANISB            |  923 | numeric | SCALE             | DV for Benefit not mentioned earlier      
 
 lcf     | 2020 | rawper | DVMrDF12      | 1     | Married                        | Married
 lcf     | 2020 | rawper | DVMrDF12      | 2     | Cohabiting                     | Cohabiting
 lcf     | 2020 | rawper | DVMrDF12      | 3     | Single                         | Single
 lcf     | 2020 | rawper | DVMrDF12      | 4     | Widowed                        | Widowed
 lcf     | 2020 | rawper | DVMrDF12      | 5     | Divorced                       | Divorced
 lcf     | 2020 | rawper | DVMrDF12      | 6     | Separated                      | Separated
 lcf     | 2020 | rawper | DVMrDF12      | 7     | Civil Partner                  | Civil_Partner
 lcf     | 2020 | rawper | DVMrDF12      | 8     | Former Separated Civil Partner | Former_Separated_Civil_Partner

 =#


using Markdown
using CSV
using GLM
using DataFrames
using RegressionTables
using StatsBase
using Statistics
using StatsModels
using CategoricalArrays
using Tidier
using StatsKit


"""
map a, which is some kind of 1d collection (typically a col from a dataframe), 
to a categorical array using the contents of Dictionary `d`
for the mapping. Missings, Nothings, and integer values < 0 are all mapped to `missing`.
"""
function to_categorical( a :: Any, d  )::CategoricalArray

   function is1( a :: Nothing, d )::Missing
      return missing
   end
   
   function is1( a :: Missing, d )::Missing
      return missing
   end
   
   function is1( a :: AbstractString )
      return is1( tryparse( Int, a ), d )
   end

   function is1( a :: CategoricalValue, d )
    return get(d, a, "$a" )
 end

   
   function is1( a :: Integer, d )
      if a < 0
         return missing
      end
      return get(d, a, "$a" )
   end

   a = categorical(map( x -> is1(x,d), a ))
end
   
lcfh = CSV.File( "/mnt/data/lcf/2021/tab/lcfs_2020_dvhh_ukanon.tab")|>DataFrame
lcf = CSV.File( "/mnt/data/lcf/2021/tab/lcfs_2020_rawper_ukanon_final.tab")|>DataFrame
n = size(lcf)[1]
leftjoin!(lcf,lcfh,on=[:case])
@assert size(lcf)[1] == n

lcnames = Symbol.(lowercase.(string.(names(lcf))))
rename!( lcf, lcnames ) # jam lowercase names
lcf = lcf[lcf.dvage6 .>1, :] # children
lcf.pays_reg_allow = .!(ismissing.(lcf.dvregp))
lcf.pays_alimony = .!(ismissing.(lcf.dvalimp))
lcf.pays_childsup = .!(ismissing.(lcf.dvchmainp))
lcf.pays_other_allow = .!(ismissing.(lcf.dvmemp))

lcf.on_uc = .! ismissing.(lcf.dvuc)

lcf.pays_any_allow = lcf.pays_reg_allow .| lcf.pays_alimony .| lcf.pays_childsup .| lcf.pays_other_allow 
lcf.dvregp = coalesce.( lcf.dvregp, 0 )  
lcf.dvalimp = coalesce.( lcf.dvalimp, 0 )  
lcf.dvchmainp = coalesce.( lcf.dvchmainp, 0 )
lcf.dvmemp = coalesce.( lcf.dvmemp, 0 ) 
lcf.total_pay_allow = lcf.dvregp .+ lcf.dvalimp .+ lcf.dvchmainp .+ lcf.dvmemp
lcf.partner_in_hh = lcf.sspart .== 1
lcf.has_children_in_hh = lcf.haschd .== 1
#=
DVRegP             |  859 | numeric | scale             | DV for RegAmP                                                                                                                                                                                   |         1
 lcf     | 2018 | rawper | DVChMainP          |  860 | numeric | scale             | DV for ChMainP                                                                                                                                                                                  |         1
 lcf     | 2018 | rawper | DVAlimP            |  861 | numeric | scale             | DV for AlimAmP                                                                                                                                                                                  |         1
 lcf     | 2018 | rawper | DVMemP   
=#

lcf.sex = to_categorical( lcf.sex, Dict([1=>"Male", 2=>"Female"]))
lcf.dvage6 = to_categorical( lcf.dvage6, Dict([1=>"0 to 15", 2=>"16 to 24", 3=>"25 to 44", 4=>"45 to 64", 5=>"65 to 74", 6=>"75 Plus"]))
lcf.dvilo3a = to_categorical(lcf.dvilo3a, Dict([1=>"In Employment",
    2=>"ILO Unemployed",
    3=>"Economically Inactive"]))

lcf.dvmrdf12 = to_categorical(lcf.dvmrdf12, Dict([
    1 =>  "Married/Civil",
    2 => "Cohabiting",
    3 => "Single",
    4 => "Widowed",                  
    5 => "Divorced",                      
    6 =>  "Separated",
    7 =>  "Married/Civil",
    8 =>  "Separated"]))
lcf.married =  lcf.dvmrdf12 .== "Married/Civil"
f1_pays_any_allow = @formula( pays_any_allow ~ sex + on_uc + dvage6 + dvilo3a + partner_in_hh + has_children_in_hh + dvmrdf12 ) 
r1_pays_any_allow = glm( f1_pays_any_allow, lcf, Binomial(), ProbitLink())
f2_pays_any_allow = @formula( pays_any_allow ~ sex + on_uc + dvage6 + dvilo3a + partner_in_hh + has_children_in_hh + married ) 
r2_pays_any_allow = glm( f2_pays_any_allow, lcf, Binomial(), ProbitLink())
f3_pays_any_allow = @formula( pays_any_allow ~ sex + on_uc + dvage6 + dvilo3a + married ) 
r3_pays_any_allow = glm( f3_pays_any_allow, lcf, Binomial(), ProbitLink())
f4_pays_any_allow = @formula( pays_any_allow ~ sex + dvage6 + dvilo3a + married ) 
r4_pays_any_allow = glm( f4_pays_any_allow, lcf, Binomial(), ProbitLink())
regtable(r1_pays_any_allow, r2_pays_any_allow, r3_pays_any_allow, r4_pays_any_allow )

summarystats(lcf[lcf.pays_any_allow.==1,:total_pay_allow])
hist = fit(Histogram,  log.(lcf[(lcf.total_pay_allow.>0) .& (lcf.total_pay_allow.< 1000),:total_pay_allow]), weight=:weighta) #; nbins=30 )
allpay=lcf[(lcf.total_pay_allow.>0) .& (lcf.total_pay_allow.< 1000),:total_pay_allow]
size(allpay)/size(lcf)[1] # 0.01095039633897197
popn = sum(weighta)
@chain lcf begin
    @filter( allpay > 0 )
    @summarize( 
       mean_allpay = sum( allpay * weighta )/sum(weighta),
       pct_allpay = 100*sum( weighta )/!!popn # double bang
end

#
# Crude add in to my dataset
#
mpers = CSV.File( "/home/graham_s/julia/vw/ScottishTaxBenefitModel/data/model_people_scotland-2015-2021.tab")|>DataFrame
mpers = mpers[mpers.from_child_record.==false,:]
mpers.dvmrdf12 = to_categorical(mpers.marital_status, Dict([
    1 =>  "Married/Civil",
    2 => "Cohabiting",
    3 => "Single",
    4 => "Widowed",                  
    5 =>  "Separated",
    6 => "Divorced"]))

n = size(mpers)[1]

mpers.dvage6 = fill("",n)
rename!( mpers, :sex => :isex )
pers.sex = to_categorical( pers.sex, Dict([1=>"Male", 2=>"Female"]))
pers.dvilo3a = to_categorical(pers.employment_status,Dict([
    1=>"In Employment",
    2=>"In Employment",
    3=>"In Employment",
    4=>"In Employment",
    5=>"ILO Unemployed",
    6=>"Economically Inactive",
    7=>"Economically Inactive",
    8=>"Economically Inactive",
    9=>"Economically Inactive",
    10=>"Economically Inactive",
    11=>"Economically Inactive"]))
# fiish
for r in eachrow(mpers)
    r.dvage6 = if r.age <= 24
            "16 to 24"
        elseif r.age <= 44
            "25 to 44"
        elseif r.age <= 64
            "45 to 64"
        elseif r.age <= 74
            "65 to 74"
        else
            "75 Plus"
        end      
end
mpers.dvage6 = categorical(mpers.dvage6)
    

